package.json

{
  "name": "vault-postgres-app",
  "version": "1.0.0",
  "main": "app.js",
  "dependencies": {
    "axios": "^1.6.0",
    "pg": "^8.10.0"
  }
}


app.js

const axios = require('axios');
const { Client } = require('pg');

// Vault & Postgres config
const VAULT_ADDR = 'http://vault:8200';
const VAULT_TOKEN = 'myroot';  // Replace with real token
const SECRET_PATH = 'database/data/postgres';
const POSTGRES_HOST = 'postgres-db';
const POSTGRES_DB = 'mydb';

// Step 1: Get secret from Vault
axios.get(`${VAULT_ADDR}/v1/${SECRET_PATH}`, {
  headers: { 'X-Vault-Token': VAULT_TOKEN }
})
.then(response => {
  const { username, password } = response.data.data.data;

  // Step 2: Connect to Postgres using credentials
  const client = new Client({
    user: username,
    password: password,
    host: POSTGRES_HOST,
    database: POSTGRES_DB,
    port: 5432,
  });

  client.connect()
    .then(() => {
      console.log('✅ Connected to Postgres using Vault credentials');
      return client.end();
    })
    .catch(err => {
      console.error('❌ DB connection error:', err.message);
    });

})
.catch(err => {
  console.error('❌ Vault fetch error:', err.message);
});

Dockerfile

FROM node:20

WORKDIR /app
COPY package*.json ./
RUN npm install
COPY app.js .

CMD [ "node", "app.js" ]


alternative:

// vault-get.js
const VAULT_ADDR = 'http://hcv:8200'; // Replace with your container Vault address
const SECRET_PATH = '/v1/secret/data/myapp'; // Replace with your actual path
const VAULT_TOKEN = 'hvs.xxxxx'; // Replace with your actual Vault token

async function fetchSecret() {
  try {
    const response = await fetch(`${VAULT_ADDR}${SECRET_PATH}`, {
      method: 'GET',
      headers: {
        'X-Vault-Token': VAULT_TOKEN
      }
    });

    if (!response.ok) {
      throw new Error(`Vault fetch error: ${response.status} ${response.statusText}`);
    }

    const data = await response.json();
    console.log('Secret data:', data);
  } catch (err) {
    console.error(err.message);
  }
}

fetchSecret();
----------------------------------------------------------------------
// app.js
import fetch from 'node-fetch';
import pg from 'pg';

const VAULT_ADDR = 'http://hcv:8200'; // Use the container name of Vault
const VAULT_TOKEN = process.env.VAULT_TOKEN; // Pass via environment variable
const VAULT_SECRET_PATH = '/v1/secret/data/database/postgres';

async function fetchDbCredentials() {
  const res = await fetch(`${VAULT_ADDR}${VAULT_SECRET_PATH}`, {
    headers: {
      'X-Vault-Token': VAULT_TOKEN
    }
  });

  if (!res.ok) {
    throw new Error(`Vault fetch failed: ${res.status}`);
  }

  const secret = await res.json();
  return secret.data.data;
}

async function connectToPostgres({ username, password }) {
  const client = new pg.Client({
    user: username,
    password: password,
    host: 'postgres',  // container name of your PostgreSQL instance
    database: 'postgres',
    port: 5432
  });

  await client.connect();
  const result = await client.query('SELECT NOW()');
  console.log('PostgreSQL time:', result.rows[0]);
  await client.end();
}

(async () => {
  try {
    const creds = await fetchDbCredentials();
    await connectToPostgres(creds);
  } catch (err) {
    console.error('Error:', err.message);
  }
})();

# package.json

{
  "name": "vault-postgres-app",
  "version": "1.0.0",
  "type": "module",
  "main": "app.js",
  "dependencies": {
    "pg": "^8.11.3",
    "node-fetch": "^3.3.2"
  }
}

# Dockerfile
FROM node:20

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY app.js ./

CMD ["node", "app.js"]
-------------------------------------------------------
// app.js
const VAULT_ADDR = 'http://hcv:8200'; // Vault container hostname (in net1)
const VAULT_SECRET_PATH = '/v1/secret/data/database/postgres'; // KV v2 path
const VAULT_TOKEN = process.env.VAULT_TOKEN; // Vault token from env

async function fetchSecret() {
  try {
    const response = await fetch(`${VAULT_ADDR}${VAULT_SECRET_PATH}`, {
      method: 'GET',
      headers: {
        'X-Vault-Token': VAULT_TOKEN
      }
    });

    if (!response.ok) {
      throw new Error(`Vault fetch failed: ${response.status} ${response.statusText}`);
    }

    const json = await response.json();
    const data = json.data.data;

    console.log('📦 Fetched secret from Vault:');
    console.log('Username:', data.username);
    console.log('Password:', data.password);

  } catch (error) {
    console.error('❌ Error fetching secret from Vault:', error.message);
  }
}

fetchSecret();

----------------------------------------------------------
Dockerfile
----------

FROM cache.artifactory.global.standardchartered.com/gv-images-products/scb-bases/gts-1114/node-builder:20.19.1-micro-6314908 as builder
COPY --chown=$USER package.json /opt/app/application/
WORKDIR /opt/app/application
RUN npm install
RUN ls -1

FROM artifactory.global.standardchartered.com/gv-images-products/scb-bases/gts-1114/node:20.19.1-micro-6679849
# copy installed dependencies from the previous image
COPY --from=builder --chown=$USER /opt/app/application/node_modules /opt/app/application/node_modules
# copy in your script(s)
COPY --chown=$USER app.js /opt/app/application/

EXPOSE 3000
# by default in base image, container starts with "node server.js", replace "server.js" with your file name
RUN sed -i 's\server.js\app.js\g' /opt/app/run.sh
CMD ["node", "app.js"]

Package.json
------------

{
  "name": "vault-postgres-app",
  "version": "1.0.0",
  "type": "module",
  "main": "app.js",
  "dependencies": {
    "pg": "^8.11.3",
    "node-fetch": "^3.3.2"
  }
}


app.js
------
import axios from 'axios';
import pg from 'pg';
const { client } = pg;
// const axios = require('axios');
// const { Client } = require('pg');

// Vault & Postgres config
const VAULT_ADDR = process.env.VAULT_ADDR;  // replace with VM IP
const VAULT_TOKEN = process.env.VAULT_TOKEN  // Replace with real token
const SECRET_PATH = 'secret/data/database/postgres'; // Replace with right path where your secrets are saved // KV2 automatically adds data after secret
const POSTGRES_HOST = 'postgres-db';
const POSTGRES_DB = 'mydb';

//const secretPath = 'secret/data/database/postgres';
console.log("vault request URL =", '${process.env.VAULT_ADDR}/v1/${SECRET_PATH}');
// console.log('Fetching from Vault:', '${VAULT_ADDR}/v1/${SECRET_PATH}');

// Step 1: Get secret from Vault
axios.get(`${VAULT_ADDR}/v1/${SECRET_PATH}`, {
  headers: { 'X-Vault-Token': VAULT_TOKEN }
})
.then(response => {
  const { username, password } = response.data.data.data;

  // Step 2: Connect to Postgres using credentials
  const client = new Client({
    user: username,
    password: password,
    host: POSTGRES_HOST,
    database: POSTGRES_DB,
    port: 5432,
  });

  client.connect()
    .then(() => {
      console.log('✅ Connected to Postgres using Vault credentials');
      return client.end();
    })
    .catch(err => {
      console.error('❌ DB connection error:', err.message);
    });

})
emerg1@uklvadsb0291[DEV][~] $ sudo podman logs node-app
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   219    0   219    0     0   2517      0 --:--:-- --:--:-- --:--:--  2517
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  1120    0  1120    0     0   9491      0 --:--:-- --:--:-- --:--:--  9491
Getting latest cert bundle: /com/scb/pki/icabundle/internalcacertsbundleall.002.crt
Fetching certs from https://artifactory.global.standardchartered.com/artifactory/generic-production//com/scb/pki/icabundle/internalcacertsbundleall.002.crt if SCBINTERNALCACERT_URL not specified
SCBINTERNALCACERT URL was not provided/empty, defaulting to fetch certs from original URL
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0200
Replacing current certs with new certs
100 74248  100 74248    0     0   609k      0 --:--:-- --:--:-- --:--:--  604k
❌ Vault fetch error: Request failed with status code 403

CONTAINER ID  IMAGE                                                            COMMAND          CREATED         STATUS                   PORTS                   NAMES
7229313002cf  artifactory.global.standardchartered.com/hashicorp/vault:latest  server -dev      41 hours ago    Up 41 hours              0.0.0.0:8200->8200/tcp  hcv
d730008d0082  artifactory.global.standardchartered.com/postgres:12             postgres         41 hours ago    Up 41 hours              0.0.0.0:5432->5432/tcp  postgres-db
faeaf08bf99c  localhost/node-vault-app:latest                                  /opt/app/run.sh  40 hours ago    Exited (0) 40 hours ago  0.0.0.0:3000->3000/tcp  node-app
4ba3a0ff3b93  artifactory.global.standardchartered.com/ubuntu:latest           bash             20 minutes ago  Up 20 minutes                                    ubuntu

